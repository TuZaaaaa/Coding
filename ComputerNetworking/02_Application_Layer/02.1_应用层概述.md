# 应用层原理

## 应用架构

### C/S
- Server
  - 一直运行
  - 固定ip和端口
  - 扩展性
    - 数据中心进行扩展
    - 扩展性差（断崖式下降）
- Client
  - 主动与服务器通信
  - 与互联网络有间歇性的链接
  - 可能是动态ip
  - 不直接与其他客户端通信
### P2P
- （几乎）没有一直运行的服务器
- 任意端系统之间可以进行通信
- 每一个节点既是客户端又是服务器
  - 自扩展性：新 peer 节点带来新的服务能力，同时也带来新的服务请求
- 参与的主机间歇性连接且可以改变ip
  - 难以管理
### 混合
- Napster
  - 文件搜索：集中
    - 资源注册/查询资源
  - 文件传输：P2P
    - 任何 peer 节点之间
- 即时通信
  - 在线检测：集中
    - 用户上线，注册ip
    - 用户与中心服务器通信，找到其在线好友的位置
    - 两个用户之间聊天：P2P

## 进程通信
- 同一主机，使用进程间通信机制通信（操作系统定义）
- 不同主机，通过交换报文（Message）来通信
  - 使用 OS 提供的通信服务
  - 按照应用协议交换报文
    - 借助传输层提供的服务
- 客户端进程：发起通信的进程
- 服务器进程：等待连接的进程

## 分布式进程通信需要解决的问题
- Q1: 进程标识和寻址问题（服务用户）
- Q2: 传输层-应用层如何提供服务（服务）
  - 位置：层间界面的 SAP(TCP/IP: socket)
  - 形式：应用程序接口 API(TCP/IP: socket API)
- Q3: 如何使用传输层提供的服务，实现应用进程之间的报文交换，实现应用（用户使用服务）
  - 定义应用层协议：报文格式，解释，时序等
  - 编写程序，使用 OS 提供的 API，调用网络基础设施提供通信服务传输报文，实现应用时序等

### Q1: 对进程进行编址（addressing）
- 进程为了接收报文，必须有一个**标识**
  - 主机：唯一的 32 位 IP 地址
  - 传输层协议：TCP/UDP
  - port
- 本质上，一对主机进程之间的通信由 2 个端节点构成

### Q2: 传输层提供的服务-需要穿过层间的信息
- 层间接口必须要携带的信息
  - 要传输的报文（对于本层来说：SDU）
  - 谁传的：对方的应用进程的标识：IP+TCP/UDP port
  - 传给谁：对方的应用进程的标识：对方的 IP+TCP/UDP port
- 传输层实体（tcp/udp）根据这些信息进行 TCP 报文段（UDP 数据报）的封装
  - 源/目标端口号，数据等
  - 将 IP 地址往下交 IP 实体，用于封装 IP 数据报：源 IP，目标 IP

### Q2: 传输层提供的服务-层间信息的代表
- 如果 Socket API 每次传输报文，都携带如此多的信息，太繁琐易错，不便于管理
- 用代号标识通信的双方或单方：socket
- 类似 OS 打开文件返回的句柄
  - 对句柄的操作，就是对文件的操作

## TCP之上的 scoket
> 对于面向连接服务（TCP）的应用而言，套接字是 4 元组的一个具有**本地意义的标识**
- 4 元组：（源IP，源port，目标IP，目标port）
- TCP服务，两个进程之间的通信需要之前要建立连接
  - 两个进程通信会持续一段时间，通信关系稳定
- 唯一指定一个会话（2 个进程之间的会话关系）
- 应用使用这个**标识**，与远程的应用进行通信
- 穿过层间接口的信息量**最小**
- 不必每一个报文发送都指定这 4 元组
- 简单，便于管理

## UDP 之上的 socket
> 对于使用无连接服务（UDP）的应用而言，套接字是 2 元组的一个具有**本地意义的标识**
- 2 元组：（IP, port）源端指定
- 指定了应用所在一个**端节点（end point）**
- UDP服务，两个进程之间的通信需要之前无需建立连接
  - 每个报文都是独立传输的
  - 前后报文可能给不同的分布式进程
- 发送数据报时，采用创建好的本地套接字（标识ID），就不必在发送每个报文中指明自己所采用的 ip 和 port
- 但是在发送报文时，必须要指定对方的 ip 和 udp port

## 应用层协议
- 定义了：运行在不同端系统上的应用进程如何相互交换报文
  - 交换的**报文类型**：请求和应答报文
  - 各种报文类型的**语法**：报文中的各个字段及其描述
  - 字段的**语义**：即字段取值的含义
  - 进程何时、如何发送报文及对报文进行相应的**规则**
- 公开协议
  - 由 RFC 文档定义
  - 允许互操作
  - 如：HTTP, SMTP
- 私有协议
  - 协议不公开
  - 如：Skype

### 应用需要传输层提供什么服务？如何描述传输层的服务？
- 数据丢失率
- 吞吐
- 延迟
- 安全性

### 常见应用对传输服务的要求

| 应用 | 数据丢失率 | 吞吐 | 时间敏感性 | 
| --- | --- | ---| --- | 
| 文件传输 | 不能丢失 | 弹性 | 不 | 
| 实时音视频 | 容忍丢失 | 音频：5kbps-1Mbps，视频：100kbps-5Mbps | 是，100ms | 
| 存储音视频 | 容忍丢失 | 同上 | 是，几秒 |


### SSL
> Secure Sockets Layer
> 应用采用 SSL 库，SSL 使用 TCP 通信

- TCP & UDP
  - 都没有加密
  - 明文通过互联网传输，甚至密码